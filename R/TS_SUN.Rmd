---
title: "TS"
author: "SUNMI JU"
date: "5/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", message=F, warning=F)

library(ftsa)
library(ggplot2)
```

* COVID19 - 480일 2020.01.22부터 2021.05.15까지 일별 확진자
* SARS - 
* MERSE - 
* H1N1 - 

# Data Cleansing
```{r eval=FALSE}
print("Don't run me")
covid <- read.csv('../Data/COVID19.csv')
covid_ <- aggregate(. ~ Country, covid[2:ncol(covid)], sum)

colname <- as.character(as.Date(as.character(c(
  seq(200122,200131), seq(200201,200229), seq(200301,200331), 
  seq(200401,200430), seq(200501,200531), seq(200601,200630),
  seq(200701,200731), seq(200801,200831), seq(200901,200930),
  seq(201001,201031), seq(201101,201130), seq(201201,201231),
  seq(210101,210131), seq(210201,210228), seq(210301,210331),
  seq(210401,210430), seq(210501,210515))), "%y%m%d"))

sum(is.na(colname)) # Fine
colnames(covid_) <- c("Country", colname)

sars <- read.csv('../Data/SARS.csv')
sars$Date <- as.Date(sars$Date, "%Y.%m.%d")

h1n1 <- read.csv('../Data/H1N1.csv')
h1n1$Date <- as.Date(h1n1$Date, "%Y.%m.%d")

write.csv(covid_, '../Data/COVID19_.csv', row.names = FALSE)
```

# Make fts Object / 20 days
- https://stackoverflow.com/questions/39507618/creating-fts-object-in-r
```{r}
covid <- read.csv('../Data/COVID19_.csv')

MakeFtsObject <- function(country, days){
  x <- seq(1, days, 1)
  total <- ncol(covid) - days*1 - 1
  nc <- as.numeric(total%/%days)
  y <- matrix(as.numeric(covid[covid$Country == country, 2:(nc*days+1)]), 
              ncol=nc, byrow=FALSE)
  covid_fts <- rainbow::fts(x = x, y = y, xname="Date", yname=paste(country, "new confimation cases by 20 days"))
  colnames(covid_fts$y) <- c(as.character(seq(1,nc)))
  rownames(covid_fts$y) <- c(as.character(seq(1,days)))
  
  return(covid_fts)
}

# Time Series Predict Plotting 1
FtsObjectPlot1 <- function(covid_fts, country, days, ymin, ymax){
  plot(covid_fts, col = gray(0.8), xlab = "Date", ylab = "new confirmed cases", 
       main = paste(country, "/ Predict daily new confirmed cases in", days, "days"), 
       ylim = c(min(covid_fts$y)*ymin, max(covid_fts$y)*ymax))
  plot(forecast(ftsm(covid_fts, order = 3), h = 1), col='red', lwd=2, add = TRUE, 
       ylim = c(min(covid_fts$y)*ymin, max(covid_fts$y)*ymax))
  legend("bottomright", paste0("1-", days, " days"), col = c("red"))
}

# Time Series Predict Plotting 2
### 전역변수 covid data 필요, predict 비교할 때 nc*days + 2 부터
FtsObjectPlot2 <- function(covid_fts, country, days, nc){
  covid_fts_pre <- forecast(ftsm(covid_fts, order = 3), h = 1, stationary=FALSE, method = "arima") # method = "ets"
  df <- data.frame(X = seq(nc*days + days*1),
                 Y = as.numeric(covid[covid$Country == country, 2:(nc*days+days*1+1)]),
                 Yhat = c(rep(NA, nc*days-1), covid[covid$Country == country, (nc*days+1)], as.vector(covid_fts_pre$mean$y)),
                 Lower = c(rep(NA, nc*days), as.vector(covid_fts_pre$lower$y)),
                 Upper = c(rep(NA, nc*days), as.vector(covid_fts_pre$upper$y)))

  ggplot(df) + geom_errorbar(aes(x=X, y=Yhat, ymin=Lower,ymax=Upper),color='pink', alpha=0.5, position="dodge",width=0.2) +
    geom_line(aes(x=X, y=Y), color='darkgrey') + geom_line(aes(x=X, y=Yhat), color='red') + theme_bw() + 
    ggtitle(paste(country, "/ Predict daily new confirmed cases in", days, "days")) + theme(plot.title = element_text(hjust=0.5, size=12, face="bold"))
}

# 왜 sd가 거꾸로 나오는지?
# ets, arima 등 일반 시계열에서 ets, arima 방법처럼 사용해도 되는건지
```

# Make fts Object / 14 days
```{r}
days <- 14
total <- ncol(covid) - days*1 - 1
nc <- as.numeric(total%/%days)

country <- 'China'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'US' # 먼가 모델이 잘못됬나봄
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.5, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'Korea, South'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.15)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'New Zealand'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)
```

# Make fts Object / 30 days
```{r}
days <- 30
total <- ncol(covid) - days*1 - 1
nc <- as.numeric(total%/%days)

country <- 'China'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'US'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.5, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'Korea, South'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.15)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'New Zealand'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)
```
오히려 장기 예측이 강한가? 패턴을 알기 좋다!

# Make fts Object / 60 days
```{r}
days <- 60
total <- ncol(covid) - days*1 - 1
nc <- as.numeric(total%/%days)

country <- 'China'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'US'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.5, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'Korea, South'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.15)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'New Zealand'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)
```
약간 편차가 크다..? order를 높여야하나?
잘 예측되는지는 MSE 구해야되나?

우리나라를 잘 맞춤.. 뭐지.. 왜지.. 정상성, 모델의 문제?

# Make fts Object / 90 days
```{r}
days <- 90
total <- ncol(covid) - days*1 - 1
nc <- as.numeric(total%/%days)

country <- 'China'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'US'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.5, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'Korea, South'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.15)
FtsObjectPlot2(covid_fts, country, days, nc)

country <- 'New Zealand'
covid_fts <- MakeFtsObject(country, days)
FtsObjectPlot1(covid_fts, country, days, 0.95, 1.05)
FtsObjectPlot2(covid_fts, country, days, nc)
```

아! 90을 보니.. 지금 functional 은 일종의 패턴을 예측? 하는 느낌. 곡선을 예측
그래서 yhat1을 원 데이터의 위치에 맞추던가, 아니면 머 평균 가장 작게하는 위치에 맞추던가 해야될듯, y의 평행이동이 필요해보이고, 다음날 정확한 값 예측?이건 절대불가능이고 패턴 예측에 도움이 될듯.